# Chat Changes Algorithm - Implementation Guide

This document contains all the changes made to the chat functionality today. Follow these steps to implement the same changes in a newer version.

## Summary of Changes
1. Moved "To positions" button from chat bubble to input row
2. Added streaming text animation when chat is empty
3. Removed example messages, kept only initial AI greeting
4. Fixed chat window height to be constant

---

## Step 1: Update `core/templates/core/chat.html`

### 1.1 Remove "To positions" button from chat bubble
- **Find**: The `<a href="{% url 'positions' %}" class="cv-primary-btn cv-chat-inline-btn">` inside any chat bubble
- **Action**: Delete that entire button/link element

### 1.2 Add "To positions" button to input row
- **Find**: The `<div class="cv-chat-input-row" id="cv-chat-input-row">` section
- **Find**: The send button `<button class="cv-send-btn" type="button" id="cv-send-btn">→</button>`
- **Action**: Add the button BEFORE the send button:
```html
<a href="{% url 'positions' %}" class="cv-primary-btn cv-positions-btn" id="cv-positions-btn">{% trans "To positions →" %}</a>
```

### 1.3 Add empty message container for streaming text
- **Find**: `<div class="cv-chat-window" id="cv-chat-window">`
- **Action**: Add this RIGHT AFTER the opening tag:
```html
<!-- Streaming text when chat is empty -->
<div class="cv-chat-empty-message" id="cv-chat-empty-message">
  <span id="cv-streaming-text"></span>
</div>
```

### 1.4 Remove all example messages, keep only initial AI greeting
- **Find**: All example chat rows (both user and AI messages)
- **Action**: Delete ALL example messages
- **Action**: Add ONLY this initial AI message:
```html
<!-- Initial AI greeting -->
<div class="cv-chat-row cv-chat-row-ai">
  <div class="cv-chat-bubble cv-chat-bubble-ai">
    {% trans "Hi, how can I help you?" %}
  </div>
  <div class="cv-avatar cv-avatar-ai">AI</div>
</div>
```

**Final chat window structure should be:**
```html
<div class="cv-chat-window" id="cv-chat-window">
  <!-- Streaming text when chat is empty -->
  <div class="cv-chat-empty-message" id="cv-chat-empty-message">
    <span id="cv-streaming-text"></span>
  </div>
  <!-- Initial AI greeting -->
  <div class="cv-chat-row cv-chat-row-ai">
    <div class="cv-chat-bubble cv-chat-bubble-ai">
      {% trans "Hi, how can I help you?" %}
    </div>
    <div class="cv-avatar cv-avatar-ai">AI</div>
  </div>
</div>
```

**Final input row structure should be:**
```html
<div class="cv-chat-input-row" id="cv-chat-input-row">
  <input type="file" id="cv-file-input" accept=".pdf,application/pdf" style="position: absolute; width: 1px; height: 1px; opacity: 0; overflow: hidden;">
  <button class="cv-upload-btn" type="button" id="cv-upload-btn" title="{% trans 'Upload PDF CV' %}">+</button>
  <input class="cv-chat-input" type="text" id="cv-chat-input" placeholder="{% trans 'Upload your CV or ask any questions' %}">
  <a href="{% url 'positions' %}" class="cv-primary-btn cv-positions-btn" id="cv-positions-btn">{% trans "To positions →" %}</a>
  <button class="cv-send-btn" type="button" id="cv-send-btn">→</button>
</div>
```

---

## Step 2: Update `core/static/core/chat.js`

### 2.1 Add streaming text variables and functions
- **Find**: The `DOMContentLoaded` event listener
- **Find**: Where variables are declared (fileInput, uploadBtn, chatInput, etc.)
- **Action**: Add these variables after the existing ones:
```javascript
const emptyMessage = document.getElementById('cv-chat-empty-message');
const streamingText = document.getElementById('cv-streaming-text');
```

- **Action**: Add these functions AFTER the variable declarations but BEFORE the file upload handlers:
```javascript
// Streaming text animation
let streamingInterval = null;
const fullText = 'We are ready to start...';
let currentIndex = 0;

function startStreaming() {
  if (streamingInterval) return;
  currentIndex = 0;
  streamingText.textContent = '';
  
  streamingInterval = setInterval(() => {
    if (currentIndex < fullText.length) {
      streamingText.textContent += fullText[currentIndex];
      currentIndex++;
    } else {
      // Restart from beginning
      currentIndex = 0;
      streamingText.textContent = '';
    }
  }, 100);
}

function stopStreaming() {
  if (streamingInterval) {
    clearInterval(streamingInterval);
    streamingInterval = null;
  }
  if (emptyMessage) {
    emptyMessage.style.display = 'none';
  }
}

function checkChatEmpty() {
  // Check if there are any chat rows (excluding the empty message)
  const chatRows = chatWindow.querySelectorAll('.cv-chat-row');
  if (chatRows.length === 0) {
    if (emptyMessage) {
      emptyMessage.style.display = 'block';
      startStreaming();
    }
  } else {
    stopStreaming();
  }
}
```

### 2.2 Add initialization code
- **Find**: Right after the `checkChatEmpty` function
- **Action**: Add initialization code:
```javascript
// Initialize: check if chat is empty on load
// Check if there are any chat rows (example messages or real messages)
const chatRows = chatWindow.querySelectorAll('.cv-chat-row');
if (chatRows.length > 0) {
  // Chat has messages, hide empty message
  if (emptyMessage) {
    emptyMessage.style.display = 'none';
  }
} else {
  // Chat is empty, show streaming text
  if (emptyMessage) {
    emptyMessage.style.display = 'block';
    startStreaming();
  }
}
```

### 2.3 Update `addUserMessage` function
- **Find**: The `addUserMessage` function
- **Find**: Where it appends the row and calls `scrollToBottom()`
- **Action**: Add this line BEFORE `scrollToBottom()`:
```javascript
// Hide empty message when first message is added
checkChatEmpty();
```

### 2.4 Update `addAIMessageWithId` function
- **Find**: The `addAIMessageWithId` function (or `addAIMessage` if it calls this)
- **Find**: Where it appends the row and calls `scrollToBottom()`
- **Action**: Add this line BEFORE `scrollToBottom()`:
```javascript
// Hide empty message when message is added
checkChatEmpty();
```

---

## Step 3: Update `core/static/core/styles.css`

### 3.1 Fix chat window height
- **Find**: `.cv-chat-window` class
- **Find**: `max-height: 420px;`
- **Action**: Change to `height: 420px;` (remove "max-")

### 3.2 Add empty message styling
- **Find**: After `.cv-chat-window` styles
- **Action**: Add:
```css
.cv-chat-empty-message {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 200px;
  color: #876e65;
  font-size: 16px;
  font-style: italic;
}
```

### 3.3 Add positions button styling in input row
- **Find**: `.cv-chat-input-row` class
- **Action**: Add after the existing styles:
```css
.cv-positions-btn {
  font-size: 14px;
  padding: 8px 16px;
  white-space: nowrap;
  flex-shrink: 0;
}
```

### 3.4 Update chat window position
- **Find**: `.cv-chat-window` class
- **Action**: Make sure it has `position: relative;` (add if missing)

---

## Step 4: Verification Checklist

After implementing all changes, verify:

- [ ] "To positions" button appears in input row, to the left of send button
- [ ] Button has same gradient styling as before
- [ ] Button navigates to positions page when clicked
- [ ] Chat window has fixed height of 420px from start
- [ ] Only one initial AI message "Hi, how can I help you?" appears on right side
- [ ] No example messages are visible
- [ ] Streaming text "We are ready to start..." appears if chat becomes empty (test by removing all messages)
- [ ] Streaming text hides when messages are added
- [ ] Chat scrolls properly when content exceeds window height

---

## Quick Reference: Key Changes

1. **HTML**: Button moved from bubble to input row
2. **HTML**: Added empty message container
3. **HTML**: Removed examples, kept only initial AI greeting
4. **JS**: Added streaming text animation logic
5. **JS**: Added checkChatEmpty() calls in message functions
6. **CSS**: Changed max-height to height for fixed size
7. **CSS**: Added empty message and button styles

---

## Notes

- The streaming text only shows when chat is completely empty (no chat rows)
- Since we have an initial AI message, streaming text will be hidden by default
- The button uses the same `cv-primary-btn` class for consistent styling
- All changes maintain existing functionality while adding new features
